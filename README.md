# LLM Clipper: クイックLLMプロンプト実行ツール

## 1. 概要

LLM Clipperは、クリップボードの内容をコンテキストとして、事前に登録したプロンプトをLLM（大規模言語モデル）に送信し、その結果をクリップボードに格納するWindowsデスクトップアプリケーションです。

ユーザーが任意のテキストを選択・コピーした後、マウスの拡張ボタンなどに本アプリのメイン機能の実行を割り当てることで、ワンクリックでLLMによる処理（翻訳、要約、校正など）を行い、結果をペースト可能な状態にすることを目的としています。

## 2. アプリケーション構成

本アプリは、以下の2つの実行ファイルから構成されます。

*   **メインアプリケーション (ClipperAgent.exe):**
    *   クリップボードの内容を取得し、指定されたプロンプトと組み合わせてLLM APIを呼び出し、結果をクリップボードに格納するCLI風のバックグラウンドアプリケーション。
*   **設定アプリケーション (ClipperAgentConfig.exe):**
    *   メインアプリケーションで使用するプロンプトやLLMモデルの設定を行うGUIアプリケーション。

## 3. 主な機能

### 3.1. メインアプリケーション (ClipperAgent.exe)

*   **起動と引数処理:**
    *   コマンドラインまたはショートカットキー等から実行。
    *   オプションでプロンプト名を引数として指定可能。
    *   引数がない場合はデフォルトプロンプトを使用。
    *   実行中のウィンドウは非表示。
*   **クリップボード連携 (入力):**
    *   現在のクリップボードの内容をテキストとして取得。
*   **プロンプト処理:**
    *   設定ファイルからプロンプト本文と利用モデルを取得。
    *   プロンプト本文中の `${clipboard}` をクリップボードのテキストに置換。
*   **Gemini API連携:**
    *   `.env` ファイルからAPIキー等を読み込み、Gemini APIにリクエストを送信。
    *   エラーハンドリング（APIキーエラー、ネットワークエラー等）。
*   **結果のクリップボード格納 (出力):**
    *   APIからの正常なレスポンスをクリップボードに格納。
*   **デスクトップ通知:**
    *   処理の成功、エラー、情報などを非侵入的なGUIウィンドウで表示。
    *   エラー時は黄色背景と赤いタイトル、成功時は青/灰色背景で表示。
    *   フォーカスを奪わず、タイムアウト後（デフォルト5秒）に自動的に閉じる。
*   **ロギング:**
    *   処理ログをファイルに記録。

### 3.2. 設定アプリケーション (ClipperAgentConfig.exe)

*   **プロンプト管理:**
    *   プロンプトの一覧表示。
    *   プロンプトの追加、編集、削除。
    *   プロンプト名、プロンプト本文、利用モデルの設定。
*   **デフォルトプロンプト設定:**
    *   一覧からデフォルトとして使用するプロンプトを指定。
*   **LLM設定連携:**
    *   `.env` ファイルから利用可能なLLMモデルリストを読み込み、選択肢として表示。
*   **設定の保存・読み込み:**
    *   設定内容は `settings.json` ファイルに保存・読み込み。

## 4. 設定ファイル

*   **`settings.json`:**
    *   プロンプト定義（プロンプト名、本文、利用モデル）、デフォルトプロンプト名を保存。
    *   保存場所: ユーザーのアプリケーションデータディレクトリ (例: `%APPDATA%\ClipperAgent\settings.json`)
*   **`.env`:**
    *   APIキー、APIエンドポイント（オプション）、利用可能なLLMモデルリストを保存。
    *   保存場所: 実行ファイルと同じディレクトリ、またはユーザーのアプリケーションデータディレクトリ。
    *   `.env.example`ファイルを`.env`にコピーして、APIキーを設定してください。
    *   Gemini APIキーは[Google AI Studio](https://aistudio.google.com/)から取得できます。
    *   `.env`ファイルの例:
        ```
        # Gemini APIキー
        GEMINI_API_KEY="your_api_key_here"
        # 使用可能なモデルリスト
        AVAILABLE_MODELS="gemini-pro,gemini-1.5-flash"
        ```

## 5. 開発ステップ

1.  **ステップ1: 設定ファイルの基礎構造と設定アプリのコア機能 (初期)** ✅
    *   **対象:** `ClipperAgentConfig` (GUI), `settings.json`
    *   **内容:**
        *   `settings.json` の基本的な読み書きロジック（空のファイルからの開始、プロンプト名・本文・モデルIDを持つプロンプトオブジェクトのリスト構造）。
        *   `ClipperAgentConfig.exe` のGUI骨子作成 (Tkinter推奨)。
        *   プロンプト名、プロンプト本文のテキスト入力フィールド、利用モデルのドロップダウン（最初は固定値でOK、例: "gemini-pro", "gemini-flash"）。
        *   「フォームクリア」ボタンでフォームをクリアする機能。
        *   「保存」ボタンで、フォームの内容を新しいプロンプトとして `settings.json` に追記する機能（重複チェックはまだ不要）。
        *   登録されたプロンプトの一覧を簡易的に表示するエリア（リストボックスなど）。
    *   **動作確認:** 設定アプリを起動し、複数のプロンプト情報を入力・保存し、`settings.json` に正しく記録されることを確認。アプリ再起動時に保存内容が読み込まれることを確認。

2.  **ステップ2: メインアプリの基本機能 (クリップボード入力とプロンプト組み立て)** ✅
    *   **対象:** `ClipperAgent` (CLI)
    *   **内容:**
        *   ✅ `ClipperAgent.exe` のエントリーポイント作成。
        *   ✅ クリップボードからテキストデータを取得する機能。クリップボードが空、またはテキストでない場合はエラーメッセージをコンソールに出力して終了。
        *   ✅ コマンドライン引数でプロンプト名を受け取る機能。
        *   ✅ `settings.json` を読み込み、指定されたプロンプト名のプロンプト本文を取得する機能。プロンプトが見つからない場合はエラーメッセージをコンソールに出力して終了。
        *   ✅ プロンプト本文中の `${clipboard}` を、取得したクリップボードの内容で置換する機能。
        *   ✅ 最終的に組み立てられたプロンプト文字列をコンソールに出力する。
    *   **動作確認:**
        *   ✅ 適当なテキストをコピーし、`ClipperAgent.exe "プロンプト名"` を実行して、組み立てられたプロンプトがコンソールに出力されることを確認。
        *   ✅ クリップボードが空の場合や、存在しないプロンプト名を指定した場合にエラーメッセージが出力されることを確認。

3.  **ステップ3: メインアプリのGemini API連携とクリップボード出力** ✅
    *   **対象:** `ClipperAgent` (CLI), `.env`
    *   **内容:**
        *   ✅ `.env` ファイルを作成し、`GEMINI_API_KEY="YOUR_API_KEY_HERE"` と `AVAILABLE_MODELS="gemini-pro,gemini-1.5-flash"` を記述。
        *   ✅ `.env` ファイルから `GEMINI_API_KEY` を読み込む機能。APIキーが未設定の場合はエラーメッセージをコンソールに出力して終了。
        *   ✅ `settings.json` から取得したモデルIDと、組み立てたプロンプトを使用してGemini APIにリクエストを送信する機能 (Python用 Google AI SDK `google-generativeai` を使用)。
        *   ✅ APIからのレスポンス（生成されたテキスト）を取得する機能。
        *   ✅ 取得したテキストをクリップボードに書き込む機能。
        *   ✅ API呼び出しに関するエラー（認証エラー、ネットワークエラー、APIからのエラーレスポンス等）が発生した場合、エラーメッセージをコンソールに出力して終了。
    *   **動作確認:** ✅
        *   ✅ 有効なAPIキーを `.env` に設定。
        *   ✅ テキストをコピーし、`ClipperAgent.exe "プロンプト名"` を実行。LLMからの応答がクリップボードにコピーされることを確認。
        *   ✅ APIキーが無効な場合やネットワークエラー時に、適切なエラーメッセージがコンソールに出力されることを確認。
        *   テキストをコピーし、`ClipperAgent.exe "プロンプト名"` を実行。LLMからの応答がクリップボードにコピーされることを確認。
        *   APIキーが無効な場合やネットワークエラー時に、適切なエラーメッセージがコンソールに出力されることを確認。

4.  **ステップ4: デスクトップ通知機能の実装** ✅
    *   **対象:** `ClipperAgent` (CLI)
    *   **内容:**
        *   ✅ 独自の非侵入的な通知ウィンドウクラス（`NotificationWindow`）を実装。
        *   ✅ メインアプリの処理成功時（クリップボードへのコピー完了後）に、「処理完了: [プロンプト名]の結果をクリップボードにコピーしました。」のようなメッセージを通知ウィンドウで表示。
        *   ✅ メインアプリの各種エラー発生時に、具体的なエラー内容を黄色背景の通知ウィンドウで表示。
        *   ✅ エラー通知と成功通知で異なる色のスタイル（エラー: 黄色背景と赤いタイトル、成功: 青/灰色背景）を適用。
        *   ✅ コンソールへのエラー出力は残しつつ、通知を追加する形とする。
        *   ✅ 通知ウィンドウはフォーカスを奪わず、タイムアウト後に自動的に閉じる機能を実装。
    *   **動作確認:** ✅ 処理成功時および各種エラー発生時に、適切な色とスタイルの通知ウィンドウが表示され、数秒後に自動的に閉じることを確認。

5.  **ステップ5: 設定アプリの機能拡充** ✅部分実装
    *   **対象:** `ClipperAgentConfig` (GUI), `settings.json`, `.env`
    *   **内容:**
        *   ✅ プロンプト一覧で選択したプロンプトの内容を編集フォームに読み込む機能。
        *   ✅ 「保存」ボタンで、既存プロンプトの場合は内容を更新する機能。
        *   ✅ 一覧で選択したプロンプトを削除する「削除」ボタン機能（確認ダイアログを表示）。
        *   ❌ プロンプト名の重複チェックを追加し、重複する場合はエラーメッセージを表示。
        *   ❌ プロンプト一覧のいずれか一つを「デフォルトプロンプト」として指定できる機能（例: ラジオボタンや専用ボタン）。設定結果は `settings.json` の `default_prompt_name` に保存。
        *   ❌ `.env` ファイルから `AVAILABLE_MODELS` を読み込み、プロンプト編集フォームの「利用モデル」ドロップダウンリストの選択肢として動的に設定する機能。`.env` が存在しない、または `AVAILABLE_MODELS` が未定義の場合は、その旨をGUI上に表示。
        *   ✅ GUIのレイアウト改善（「新規作成」ボタンを「フォームクリア」に改名しツールチップ追加、削除ボタンの配置改善）
    *   **動作状況:** 
        * プロンプト一覧でのダブルクリックでプロンプト情報が編集フォームに読み込まれます。
        * 編集後に保存すると内容が更新されます。
        * 削除ボタンでプロンプトが削除できます（確認ダイアログあり）。
        * ボタン名とツールチップで操作方法が明確になりました。

6.  **ステップ6: メインアプリの機能拡充と仕上げ**
    *   **対象:** `ClipperAgent` (CLI)
    *   **内容:**
        *   コマンドライン引数が指定されなかった場合に、`settings.json` の `default_prompt_name` に設定されたプロンプトを使用する機能。デフォルトプロンプトが未設定の場合はエラー通知。
        *   アプリケーション実行時にコマンドプロンプトウィンドウが表示されないようにする（バックグラウンド実行）。
        *   ロギング機能の実装:
            *   ユーザーのアプリケーションデータディレクトリ (例: `%APPDATA%\ClipperAgent\ClipperAgent.log`) にログファイルを出力。
            *   ログレベル（DEBUG, INFO, ERROR）を設定可能とし、通常はINFO以上を記録。
            *   タイムスタンプ、処理内容（実行プロンプト名など）、成功/失敗、エラーメッセージなどを記録。
    *   **動作確認:** 引数なしで実行した際にデフォルトプロンプトが使用されること、ウィンドウ非表示で動作すること、ログファイルが正しく生成・記録されることを確認。

7.  **ステップ7: パッケージングとドキュメント最終化**
    *   **対象:** 全体
    *   **内容:**
        *   PyInstallerなどのツールを使用して、`ClipperAgent.exe` と `ClipperAgentConfig.exe` をスタンドアロンの実行ファイルとしてパッケージングする手順を確立。
        *   README.md にインストール方法（exeの配置、`.env` の作成とAPIキー設定）、使用方法、トラブルシューティングなどを追記。
        *   初回起動時の考慮事項（設定ファイルや `.env` がない場合の案内など）を実装・ドキュメント化。
    *   **動作確認:** パッケージングされた実行ファイルが、Python環境がない状態でも動作することを確認。READMEの記述に従ってユーザーがセットアップと利用ができることを確認。

## 6. 技術スタック (予定)

*   **言語:** Python
*   **GUIライブラリ (設定アプリ):** Tkinter
*   **デスクトップ通知:** 独自のTkinterベース通知ウィンドウクラス
*   **LLM API:** Google Gemini API (SDK: `google-generativeai`)
*   **パッケージング:** PyInstaller (予定)
*   

## 7. 今後の展望 (オプション)

*   対応LLM(OpenAI/Claude)の追加
*   アイコン作成
